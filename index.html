<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Excursion Romantique</title>
  <!-- Feuilles de style Leaflet -->
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-sA+3FRsEn8ZfFBl+3NsGhccxCZcAPScGbumfIDlHT4g="
        crossorigin=""/>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    #map {
      width: 100%;
      height: 600px;
      margin-top: 1em;
      display: none; /* caché au départ */
    }
    #errorMsg {
      display: none; /* caché au départ */
      color: red;
      font-weight: bold;
      margin-top: 1em;
    }
    #jokeImage {
      display: none; /* caché au départ */
      margin-top: 1em;
      max-width: 400px;
    }
  </style>
</head>
<body>

<h1>
  Excursion Romantique
  <select id="dropdown" onchange="handleDropdown()">
    <option value="" selected disabled>-- Choisir --</option>
    <option value="guillaume">Guillaume</option>
    <option value="autre">Quelqu'un d'autre</option>
  </select>
</h1>

<div id="errorMsg"></div>
<img id="jokeImage" src="https://i.imgur.com/XIFtZJu.png" 
     alt="Petite blague" />

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-zLZf2sZJg6EWXutPe7pNi7fMgy2Z6Qx5xMt2r6i2Hwc="
        crossorigin="">
</script>

<script>
function handleDropdown() {
  const val = document.getElementById('dropdown').value;

  if (val === 'guillaume') {
    // On masque la blague, on affiche la carte
    document.getElementById('errorMsg').style.display = 'none';
    document.getElementById('jokeImage').style.display = 'none';
    document.getElementById('map').style.display = 'block';

    if (!window.mapInitialized) {
      initMap();
      window.mapInitialized = true;
    }

  } else {
    // "Quelqu'un d'autre" => on masque la carte, on affiche un message + image
    document.getElementById('map').style.display = 'none';
    document.getElementById('errorMsg').style.display = 'block';
    document.getElementById('errorMsg').innerHTML =
      "Tu as dû te tromper...<br/>" +
      "Une sortie romantique ne peut se faire qu'avec Guillaume !";
    document.getElementById('jokeImage').style.display = 'block';
  }
}

function initMap() {
  console.log("Initialisation de la carte...");
  // Centrage sur Paris pour l'exemple
  const map = L.map('map').setView([48.8566, 2.3522], 12);

  // Calque OpenStreetMap
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '© OpenStreetMap'
  }).addTo(map);

  // Requête Overpass (viewpoints + restaurants) dans un rayon de 10km
  const overpassQuery = `
    [out:json];
    (
      node["tourism"="viewpoint"](around:10000,48.8566,2.3522);
      node["amenity"="restaurant"](around:10000,48.8566,2.3522);
    );
    out;
  `;

  fetch('https://overpass-api.de/api/interpreter', {
    method: 'POST',
    body: overpassQuery
  })
  .then(response => response.json())
  .then(data => {
    console.log("Réponse Overpass reçue");
    let count = 0;
    data.elements.forEach(el => {
      if (el.type === 'node') {
        const lat = el.lat;
        const lon = el.lon;
        const name = el.tags.name || "Sans nom";
        count++;
        L.marker([lat, lon]).addTo(map)
          .bindPopup("<b>" + name + "</b>");
      }
    });
    console.log("Overpass a retourné", count, "points.");
    if (count === 0) {
      alert("Aucun point trouvé dans la zone... Essaie un rayon plus grand ou une autre ville ?");
    }
  })
  .catch(err => {
    console.error("Erreur Overpass :", err);
    alert("Erreur lors de la requête Overpass : " + err);
  });
}
</script>

</body>
</html>
