<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Excursion Romantique</title>
  <!-- Feuille de style Leaflet (sans integrity ni crossorigin) -->
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    /* Titre centré */
    h1 {
      text-align: center;
    }
    /* Carte initialement cachée */
    #map {
      width: 100%;
      height: 600px;
      margin-top: 1em;
      display: none;
    }
    /* Message d'erreur : grand, rouge, centré */
    #errorMsg {
      display: none;
      color: red;
      font-weight: bold;
      font-size: 2.5em;
      text-align: center;
      margin-top: 1em;
    }
  </style>
</head>
<body>

<h1>
  Excursion romantique avec
  <select id="dropdown" onchange="handleDropdown()">
    <option value="" selected disabled>-- Choisir --</option>
    <option value="guillaume">Guillaume</option>
    <option value="autre">Quelqu'un d'autre</option>
  </select>
</h1>

<div id="errorMsg"></div>
<div id="map"></div>

<!-- Leaflet JS (sans integrity ni crossorigin) -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
function handleDropdown() {
  const val = document.getElementById('dropdown').value;
  if (val === 'guillaume') {
    // Masquer le message d'erreur et afficher la carte
    document.getElementById('errorMsg').style.display = 'none';
    document.getElementById('map').style.display = 'block';

    // Initialiser la carte si ce n'est pas déjà fait
    if (!window.mapInitialized) {
      initMap();
      window.mapInitialized = true;
    }

  } else {
    // "Quelqu'un d'autre" => on masque la carte et on affiche un grand message
    document.getElementById('map').style.display = 'none';
    document.getElementById('errorMsg').style.display = 'block';
    document.getElementById('errorMsg').innerHTML =
      "Tu as dû te tromper...<br/>" +
      "Une sortie romantique ne peut se faire qu'avec Guillaume !";
  }
}

function initMap() {
  console.log("Initialisation de la carte...");
  // Centrage sur Paris (exemple)
  const map = L.map('map').setView([48.8566, 2.3522], 12);

  // Calque OpenStreetMap
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '© OpenStreetMap'
  }).addTo(map);

  // Requête Overpass (points de vue et restaurants dans un rayon de 10km)
  const overpassQuery = `
    [out:json];
    (
      node["tourism"="viewpoint"](around:10000,48.8566,2.3522);
      node["amenity"="restaurant"](around:10000,48.8566,2.3522);
    );
    out;
  `;

  fetch('https://overpass-api.de/api/interpreter', {
    method: 'POST',
    body: overpassQuery
  })
  .then(response => response.json())
  .then(data => {
    console.log("Réponse Overpass reçue.");
    let count = 0;

    data.elements.forEach(el => {
      if (el.type === 'node') {
        const lat = el.lat;
        const lon = el.lon;
        const name = el.tags.name || "Sans nom";
        count++;
        // Ajout d'un marqueur pour chaque node
        L.marker([lat, lon]).addTo(map)
          .bindPopup("<b>" + name + "</b>");
      }
    });

    console.log("Overpass a retourné", count, "points.");
    if (count === 0) {
      alert("Aucun point trouvé... Essaie un autre rayon ou une autre ville ?");
    }
  })
  .catch(err => {
    console.error("Erreur Overpass :", err);
    alert("Erreur lors de la requête Overpass : " + err);
  });
}
</script>

</body>
</html>
