<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Carte dynamique Overpass</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    body { margin: 0; padding: 0; }
    #map {
      width: 100%;
      height: 100vh; /* plein écran pour la démo */
    }
    #loading {
      position: absolute;
      top: 10px; left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.8);
      padding: 5px 10px;
      border-radius: 4px;
      font-weight: bold;
      display: none;
      z-index: 999;
    }
  </style>
</head>
<body>

<div id="map"></div>
<div id="loading">Chargement en cours...</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// Icônes de couleur
const greenIcon = L.icon({
  iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
  shadowUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-shadow.png',
  iconSize: [25,41], iconAnchor: [12,41], popupAnchor: [1,-34], shadowSize: [41,41]
});
const redIcon = L.icon({
  iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
  shadowUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-shadow.png',
  iconSize: [25,41], iconAnchor: [12,41], popupAnchor: [1,-34], shadowSize: [41,41]
});

// Initialisation de la carte
const map = L.map('map').setView([43.610769, 3.876716], 13);

// Calque OSM
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19
}).addTo(map);

// Groupement de marqueurs
const markersLayer = L.layerGroup().addTo(map);

// Barre (ou message) de chargement
const loadingDiv = document.getElementById('loading');

// Fonction qui construit la requête Overpass pour la bounding box courante
function buildOverpassQuery(bounds) {
  // bounds est un objet Leaflet avec getSouth(), getWest(), getNorth(), getEast()
  const s = bounds.getSouth();
  const w = bounds.getWest();
  const n = bounds.getNorth();
  const e = bounds.getEast();

  // On recherche restaurants et viewpoints dans la bounding box
  return `
    [out:json];
    (
      node["amenity"="restaurant"](${s},${w},${n},${e});
      node["tourism"="viewpoint"](${s},${w},${n},${e});
    );
    out;
  `;
}

// Fonction qui met à jour les marqueurs selon la vue actuelle
let currentFetch = null; // pour éviter chevauchements
function updateMapData() {
  // On vide d'abord le layerGroup
  markersLayer.clearLayers();

  // On affiche "chargement en cours"
  loadingDiv.style.display = 'block';

  // Annuler la requête précédente si jamais...
  // (fetch ne se cancelle pas aisément natif, c’est un exemple)
  // On peut juste ignorer le résultat précédent.

  // Construire la requête
  const bounds = map.getBounds();
  const overpassQuery = buildOverpassQuery(bounds);

  currentFetch = fetch('https://overpass-api.de/api/interpreter', {
    method: 'POST',
    body: overpassQuery
  })
  .then(r => r.json())
  .then(data => {
    // Parcourir les éléments et ajouter des marqueurs
    data.elements.forEach(el => {
      if (el.type === 'node') {
        const lat = el.lat;
        const lon = el.lon;
        const name = el.tags.name || 'Sans nom';

        let iconChoice = L.icon();
        if (el.tags.amenity === 'restaurant') {
          iconChoice = redIcon;
        } else if (el.tags.tourism === 'viewpoint') {
          iconChoice = greenIcon;
        }

        L.marker([lat, lon], { icon: iconChoice })
         .bindPopup("<b>" + name + "</b>")
         .addTo(markersLayer);
      }
    });
  })
  .catch(err => {
    console.error("Erreur Overpass:", err);
    alert("Erreur Overpass: " + err);
  })
  .finally(() => {
    // On cache le message de chargement
    loadingDiv.style.display = 'none';
  });
}

// Au premier chargement, on charge la zone courante
updateMapData();

// À chaque fois que la vue (zoom, pan) est terminée, on recharge
map.on('moveend', () => {
  updateMapData();
});
</script>
</body>
</html>
