<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Excursion Romantique (ou pas)</title>
  <!-- Feuilles de style Leaflet -->
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-sA+3FRsEn8ZfFBl+3NsGhccxCZcAPScGbumfIDlHT4g="
        crossorigin=""/>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    #map {
      width: 100%;
      height: 600px;
      margin-top: 1em;
    }
    #errorMsg {
      color: red; 
      font-weight: bold;
      margin-top: 1em;
    }
    /* On cache le RickRoll par défaut */
    #rickroll {
      display: none;
      margin-top: 2em;
    }
  </style>
</head>
<body>

<h1>
  Excursion Romantique
  <select id="dropdown" onchange="handleDropdown()">
    <option value="" selected disabled>-- Choisir --</option>
    <option value="guillaume">Guillaume</option>
    <option value="autre">Quelqu'un d'autre</option>
  </select>
</h1>

<div id="errorMsg" style="display:none;"></div>
<div id="map" style="display:none;"></div>

<!-- Petit gag RickRoll -->
<div id="rickroll">
  <iframe width="560" height="315" 
    src="https://www.youtube.com/embed/dQw4w9WgXcQ?autoplay=1"
    title="YouTube video player" frameborder="0"
    allow="accelerometer; autoplay; clipboard-write; 
           encrypted-media; gyroscope; picture-in-picture"
    allowfullscreen>
  </iframe>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-zLZf2sZJg6EWXutPe7pNi7fMgy2Z6Qx5xMt2r6i2Hwc="
        crossorigin="">
</script>

<script>
function handleDropdown() {
  const val = document.getElementById('dropdown').value;
  if (val === 'guillaume') {
    // On masque l'erreur, le RickRoll, et on affiche la carte
    document.getElementById('errorMsg').style.display = 'none';
    document.getElementById('rickroll').style.display = 'none';
    document.getElementById('map').style.display = 'block';

    // Init la carte si pas déjà fait
    if (!window.mapInitialized) {
      initMap();
      window.mapInitialized = true;
    }
  } else {
    // "Quelqu'un d'autre" => on masque la carte, on affiche un gag
    document.getElementById('map').style.display = 'none';
    document.getElementById('rickroll').style.display = 'block';
    document.getElementById('errorMsg').style.display = 'block';
    document.getElementById('errorMsg').innerHTML = 
      "Accès refusé : Vous n'êtes pas Guillaume !<br/>" +
      "Désolé, vous êtes rickrollé !";
  }
}

function initMap() {
  // Centrée sur Paris
  const map = L.map('map').setView([48.8566, 2.3522], 12);

  // Calque OpenStreetMap
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '© OpenStreetMap'
  }).addTo(map);

  // Requête Overpass (viewpoints + restaurants sur 10km autour de Paris)
  const overpassQuery = `
    [out:json];
    (
      node["tourism"="viewpoint"](around:10000,48.8566,2.3522);
      node["amenity"="restaurant"](around:10000,48.8566,2.3522);
    );
    out;
  `;

  fetch('https://overpass-api.de/api/interpreter', {
    method: 'POST',
    body: overpassQuery
  })
  .then(response => response.json())
  .then(data => {
    let count = 0;
    data.elements.forEach(el => {
      if (el.type === 'node') {
        const lat = el.lat;
        const lon = el.lon;
        const name = el.tags.name || "Sans nom";
        count++;
        L.marker([lat, lon]).addTo(map)
          .bindPopup("<b>" + name + "</b>");
      }
    });
    console.log("Overpass a retourné", count, "points.");
    if (count === 0) {
      alert("Aucun point trouvé dans la zone... Essaie d'élargir la zone ? ");
    }
  })
  .catch(err => {
    console.error("Erreur Overpass:", err);
    alert("Erreur lors de la requête Overpass : " + err);
  });
}
</script>

</body>
</html>
